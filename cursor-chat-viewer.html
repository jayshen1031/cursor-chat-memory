<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📝 Cursor 聊天历史 - 今天</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-item {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .prompt {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 15px;
            border-left: 4px solid #ff6b6b;
        }

        .response {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            padding: 15px;
            border-left: 4px solid #4ecdc4;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .chat-text {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .load-btn {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #d63031;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-item {
            animation: fadeIn 0.5s ease-out;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 加载更多按钮样式 */
        .load-more-container {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
        }

        .load-more-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .load-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .load-more-btn:active {
            transform: translateY(0);
        }

        /* 展开按钮样式 */
        .expand-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        /* 加载指示器样式 */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            .load-more-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .expand-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 Cursor 聊天历史</h1>
            <p>今天的AI对话记录 - 让每次交流都有价值</p>
        </div>

        <div class="stats-card">
            <div class="stat-item">
                <div class="stat-number" id="totalChats">0</div>
                <div class="stat-label">今日对话</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalPrompts">0</div>
                <div class="stat-label">用户提问</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalResponses">0</div>
                <div class="stat-label">AI回复</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="lastActivity">--:--</div>
                <div class="stat-label">最后活动</div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h2>💬 今日对话记录</h2>
                <input type="text" class="search-box" id="searchBox" placeholder="🔍 搜索对话内容...">
            </div>
            
            <div class="chat-list" id="chatList">
                <div class="loading" id="loadingState">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>正在加载聊天数据...</p>
                    </div>
                </div>
            </div>
        </div>

        <button class="load-btn" id="loadDataBtn" onclick="loadChatData()">
            📊 加载聊天数据
        </button>
    </div>

    <script>
        // 全局变量
        let allChats = [];
        let filteredChats = [];
        let currentPage = 0;
        const ITEMS_PER_PAGE = 20; // 每页显示20条记录
        let isLoading = false;

        // 数据库路径配置
        const DB_PATH = '/Users/jay/Library/Application Support/Cursor/User/workspaceStorage/7f55b2520382b943c40ec0aad885f2d3/state.vscdb';

        // 真实数据加载函数（优化版本）
        async function loadChatData() {
            if (isLoading) return;
            isLoading = true;
            
            const loadBtn = document.getElementById('loadDataBtn');
            const chatList = document.getElementById('chatList');
            const loadingState = document.getElementById('loadingState');
            
            loadBtn.disabled = true;
            loadBtn.textContent = '🔄 加载中...';
            
            // 显示加载进度
            loadingState.innerHTML = `
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>正在加载聊天数据...</p>
                </div>
            `;
            loadingState.style.display = 'block';
            
            try {
                // 优先尝试加载快速版本数据
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
                
                let response;
                try {
                    // 先尝试加载精简版本
                    response = await fetch('./web-chat-data-fast.json', {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    if (!response.ok) throw new Error('快速版本不可用');
                    console.log('📈 使用精简版数据加载');
                } catch {
                    // 精简版本失败，回退到完整版本
                    response = await fetch('./web-chat-data.json', {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    console.log('📊 使用完整版数据加载');
                }
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const realData = await response.json();
                    console.log('✅ 成功加载真实聊天数据:', realData.length, '条记录');
                    processChatData(realData);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('❌ 加载数据失败:', error);
                if (error.name === 'AbortError') {
                    showError('⏰ 加载超时，请检查网络连接或重试');
                } else {
                    showError(`❌ 无法加载聊天数据: ${error.message}\n\n正在显示模拟数据作为演示...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    loadMockData();
                }
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = '🔄 重新加载';
                loadingState.style.display = 'none';
                isLoading = false;
            }
        }

        // 加载模拟数据
        function loadMockData() {
            const today = new Date();
            const mockData = [
                {
                    id: 1,
                    type: 'prompt',
                    text: '结合以上文件，帮我生成展示今天聊天历史的页面',
                    timestamp: today.getTime() - 300000, // 5分钟前
                    commandType: 4
                },
                {
                    id: 2,
                    type: 'generation',
                    text: '我来帮你生成一个展示今天聊天历史的页面。首先让我运行扫描脚本来了解当前的数据结构，然后基于发现的数据创建展示页面。',
                    timestamp: today.getTime() - 280000,
                    uuid: 'f362fd02-4942-4223-b7b0-c14c7eb86bfe'
                },
                {
                    id: 3,
                    type: 'prompt',
                    text: '帮我查看当前的项目分支',
                    timestamp: today.getTime() - 7200000, // 2小时前
                    commandType: 4
                },
                {
                    id: 4,
                    type: 'generation',
                    text: '我来帮你查看当前项目的分支信息。\n\n```bash\ngit branch -a\n```\n\n当前分支: main\n远程分支: origin/main, origin/develop',
                    timestamp: today.getTime() - 7180000,
                    uuid: '7819299f-cd6d-424d-94df-b41e1f901b09'
                },
                {
                    id: 5,
                    type: 'prompt',
                    text: '不对，帮我用rollback那个分支',
                    timestamp: today.getTime() - 7000000, // 约2小时前
                    commandType: 4
                },
                {
                    id: 6,
                    type: 'generation',
                    text: '我来帮你切换到rollback分支。\n\n```bash\ngit checkout rollback\n```\n\n已成功切换到rollback分支。',
                    timestamp: today.getTime() - 6980000,
                    uuid: 'b4b94ec8-609b-478e-a220-34b01afbbed9'
                }
            ];

            processChatData(mockData);
        }

        // 处理聊天数据（优化版本）
        function processChatData(rawData) {
            // 按时间戳降序排序（最新的在前面）
            allChats = rawData.sort((a, b) => b.timestamp - a.timestamp);
            filteredChats = [...allChats];
            currentPage = 0;
            
            updateStats();
            renderChatsLazy(); // 使用懒加载渲染
            
            document.getElementById('loadingState').style.display = 'none';
            
            // 添加滚动加载更多功能
            setupInfiniteScroll();
        }

        // 更新统计信息
        function updateStats() {
            const prompts = allChats.filter(chat => chat.type === 'prompt');
            const responses = allChats.filter(chat => chat.type === 'generation');
            const lastActivity = allChats.length > 0 ? new Date(allChats[0].timestamp) : null;
            
            document.getElementById('totalChats').textContent = Math.ceil(allChats.length / 2);
            document.getElementById('totalPrompts').textContent = prompts.length;
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('lastActivity').textContent = lastActivity ? 
                lastActivity.toLocaleTimeString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',  // 北京时间
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '--:--';
        }

        // 懒加载渲染聊天记录
        function renderChatsLazy() {
            const chatList = document.getElementById('chatList');
            
            if (filteredChats.length === 0) {
                chatList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem;">💭</div>
                        <h3>暂无聊天记录</h3>
                        <p>没有找到匹配的对话记录</p>
                    </div>
                `;
                return;
            }

            // 只渲染当前页的数据
            const startIndex = 0;
            const endIndex = Math.min((currentPage + 1) * ITEMS_PER_PAGE, filteredChats.length);
            const visibleChats = filteredChats.slice(startIndex, endIndex);
            
            const chatHTML = visibleChats.map(chat => {
                const time = chat.time || new Date(chat.timestamp).toLocaleTimeString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const isPrompt = chat.type === 'prompt';
                const cssClass = isPrompt ? 'prompt' : 'response';
                const icon = isPrompt ? '👤' : '🤖';
                const label = isPrompt ? '用户提问' : 'AI回复';
                
                // 截断过长的文本
                const maxLength = 500;
                const displayText = chat.text.length > maxLength ? 
                    chat.text.substring(0, maxLength) + '...' : 
                    chat.text;
                
                return `
                    <div class="chat-item" data-id="${chat.id}">
                        <div class="${cssClass}">
                            <div class="chat-meta">
                                <span>${icon} ${label}</span>
                                <span>${time}</span>
                            </div>
                            <div class="chat-text">${escapeHtml(displayText)}</div>
                            ${chat.text.length > maxLength ? 
                                `<button class="expand-btn" onclick="expandText(${chat.id})">展开全文</button>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            chatList.innerHTML = chatHTML;
            
            // 显示加载更多按钮
            if (endIndex < filteredChats.length) {
                chatList.innerHTML += `
                    <div class="load-more-container">
                        <button class="load-more-btn" onclick="loadMoreChats()">
                            📥 加载更多 (还有 ${filteredChats.length - endIndex} 条)
                        </button>
                    </div>
                `;
            }
        }

        // 加载更多聊天记录
        function loadMoreChats() {
            currentPage++;
            renderChatsLazy();
        }

        // 展开文本
        function expandText(chatId) {
            const chat = allChats.find(c => c.id === chatId);
            if (chat) {
                const chatElement = document.querySelector(`[data-id="${chatId}"] .chat-text`);
                const expandBtn = document.querySelector(`[data-id="${chatId}"] .expand-btn`);
                
                // 使用fullText如果存在，否则使用text
                const fullText = chat.fullText || chat.text;
                chatElement.innerHTML = escapeHtml(fullText);
                
                if (expandBtn) expandBtn.remove();
            }
        }

        // 设置无限滚动
        function setupInfiniteScroll() {
            const chatList = document.getElementById('chatList');
            
            chatList.addEventListener('scroll', debounce(() => {
                if (chatList.scrollTop + chatList.clientHeight >= chatList.scrollHeight - 100) {
                    if ((currentPage + 1) * ITEMS_PER_PAGE < filteredChats.length) {
                        loadMoreChats();
                    }
                }
            }, 100));
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 搜索功能（优化版本）
        document.getElementById('searchBox').addEventListener('input', debounce(function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredChats = [...allChats];
            } else {
                filteredChats = allChats.filter(chat => 
                    chat.text.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 0; // 重置分页
            renderChatsLazy();
        }, 300)); // 300ms防抖

        // 显示错误信息
        function showError(message) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = `
                <div class="error-message">
                    <strong>提示</strong><br>
                    ${message.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 页面加载完成后自动加载数据
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面已加载，准备显示聊天历史');
            // 自动加载真实数据
            loadChatData();
        });
    </script>
</body>
</html> 