<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Cursor èŠå¤©å†å² - ä»Šå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-item {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .prompt {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 15px;
            border-left: 4px solid #ff6b6b;
        }

        .response {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            padding: 15px;
            border-left: 4px solid #4ecdc4;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .chat-text {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .load-btn {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #d63031;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-item {
            animation: fadeIn 0.5s ease-out;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        /* åŠ è½½æ›´å¤šæŒ‰é’®æ ·å¼ */
        .load-more-container {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
        }

        .load-more-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .load-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .load-more-btn:active {
            transform: translateY(0);
        }

        /* å±•å¼€æŒ‰é’®æ ·å¼ */
        .expand-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .load-more-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .expand-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Cursor èŠå¤©å†å²</h1>
            <p>ä»Šå¤©çš„AIå¯¹è¯è®°å½• - è®©æ¯æ¬¡äº¤æµéƒ½æœ‰ä»·å€¼</p>
        </div>

        <div class="stats-card">
            <div class="stat-item">
                <div class="stat-number" id="totalChats">0</div>
                <div class="stat-label">ä»Šæ—¥å¯¹è¯</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalPrompts">0</div>
                <div class="stat-label">ç”¨æˆ·æé—®</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalResponses">0</div>
                <div class="stat-label">AIå›å¤</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="lastActivity">--:--</div>
                <div class="stat-label">æœ€åæ´»åŠ¨</div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h2>ğŸ’¬ ä»Šæ—¥å¯¹è¯è®°å½•</h2>
                <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” æœç´¢å¯¹è¯å†…å®¹...">
            </div>
            
            <div class="chat-list" id="chatList">
                <div class="loading" id="loadingState">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½èŠå¤©æ•°æ®...</p>
                    </div>
                </div>
            </div>
        </div>

        <button class="load-btn" id="loadDataBtn" onclick="loadChatData()">
            ğŸ“Š åŠ è½½èŠå¤©æ•°æ®
        </button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allChats = [];
        let filteredChats = [];
        let currentPage = 0;
        const ITEMS_PER_PAGE = 20; // æ¯é¡µæ˜¾ç¤º20æ¡è®°å½•
        let isLoading = false;

        // æ•°æ®åº“è·¯å¾„é…ç½®
        const DB_PATH = '/Users/jay/Library/Application Support/Cursor/User/workspaceStorage/7f55b2520382b943c40ec0aad885f2d3/state.vscdb';

        // çœŸå®æ•°æ®åŠ è½½å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        async function loadChatData() {
            if (isLoading) return;
            isLoading = true;
            
            const loadBtn = document.getElementById('loadDataBtn');
            const chatList = document.getElementById('chatList');
            const loadingState = document.getElementById('loadingState');
            
            loadBtn.disabled = true;
            loadBtn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
            
            // æ˜¾ç¤ºåŠ è½½è¿›åº¦
            loadingState.innerHTML = `
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½èŠå¤©æ•°æ®...</p>
                </div>
            `;
            loadingState.style.display = 'block';
            
            try {
                // ä¼˜å…ˆå°è¯•åŠ è½½å¿«é€Ÿç‰ˆæœ¬æ•°æ®
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                
                let response;
                try {
                    // å…ˆå°è¯•åŠ è½½ç²¾ç®€ç‰ˆæœ¬
                    response = await fetch('./web-chat-data-fast.json', {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    if (!response.ok) throw new Error('å¿«é€Ÿç‰ˆæœ¬ä¸å¯ç”¨');
                    console.log('ğŸ“ˆ ä½¿ç”¨ç²¾ç®€ç‰ˆæ•°æ®åŠ è½½');
                } catch {
                    // ç²¾ç®€ç‰ˆæœ¬å¤±è´¥ï¼Œå›é€€åˆ°å®Œæ•´ç‰ˆæœ¬
                    response = await fetch('./web-chat-data.json', {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    console.log('ğŸ“Š ä½¿ç”¨å®Œæ•´ç‰ˆæ•°æ®åŠ è½½');
                }
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const realData = await response.json();
                    console.log('âœ… æˆåŠŸåŠ è½½çœŸå®èŠå¤©æ•°æ®:', realData.length, 'æ¡è®°å½•');
                    processChatData(realData);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                if (error.name === 'AbortError') {
                    showError('â° åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•');
                } else {
                    showError(`âŒ æ— æ³•åŠ è½½èŠå¤©æ•°æ®: ${error.message}\n\næ­£åœ¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ä½œä¸ºæ¼”ç¤º...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    loadMockData();
                }
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'ğŸ”„ é‡æ–°åŠ è½½';
                loadingState.style.display = 'none';
                isLoading = false;
            }
        }

        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®
        function loadMockData() {
            const today = new Date();
            const mockData = [
                {
                    id: 1,
                    type: 'prompt',
                    text: 'ç»“åˆä»¥ä¸Šæ–‡ä»¶ï¼Œå¸®æˆ‘ç”Ÿæˆå±•ç¤ºä»Šå¤©èŠå¤©å†å²çš„é¡µé¢',
                    timestamp: today.getTime() - 300000, // 5åˆ†é’Ÿå‰
                    commandType: 4
                },
                {
                    id: 2,
                    type: 'generation',
                    text: 'æˆ‘æ¥å¸®ä½ ç”Ÿæˆä¸€ä¸ªå±•ç¤ºä»Šå¤©èŠå¤©å†å²çš„é¡µé¢ã€‚é¦–å…ˆè®©æˆ‘è¿è¡Œæ‰«æè„šæœ¬æ¥äº†è§£å½“å‰çš„æ•°æ®ç»“æ„ï¼Œç„¶ååŸºäºå‘ç°çš„æ•°æ®åˆ›å»ºå±•ç¤ºé¡µé¢ã€‚',
                    timestamp: today.getTime() - 280000,
                    uuid: 'f362fd02-4942-4223-b7b0-c14c7eb86bfe'
                },
                {
                    id: 3,
                    type: 'prompt',
                    text: 'å¸®æˆ‘æŸ¥çœ‹å½“å‰çš„é¡¹ç›®åˆ†æ”¯',
                    timestamp: today.getTime() - 7200000, // 2å°æ—¶å‰
                    commandType: 4
                },
                {
                    id: 4,
                    type: 'generation',
                    text: 'æˆ‘æ¥å¸®ä½ æŸ¥çœ‹å½“å‰é¡¹ç›®çš„åˆ†æ”¯ä¿¡æ¯ã€‚\n\n```bash\ngit branch -a\n```\n\nå½“å‰åˆ†æ”¯: main\nè¿œç¨‹åˆ†æ”¯: origin/main, origin/develop',
                    timestamp: today.getTime() - 7180000,
                    uuid: '7819299f-cd6d-424d-94df-b41e1f901b09'
                },
                {
                    id: 5,
                    type: 'prompt',
                    text: 'ä¸å¯¹ï¼Œå¸®æˆ‘ç”¨rollbacké‚£ä¸ªåˆ†æ”¯',
                    timestamp: today.getTime() - 7000000, // çº¦2å°æ—¶å‰
                    commandType: 4
                },
                {
                    id: 6,
                    type: 'generation',
                    text: 'æˆ‘æ¥å¸®ä½ åˆ‡æ¢åˆ°rollbackåˆ†æ”¯ã€‚\n\n```bash\ngit checkout rollback\n```\n\nå·²æˆåŠŸåˆ‡æ¢åˆ°rollbackåˆ†æ”¯ã€‚',
                    timestamp: today.getTime() - 6980000,
                    uuid: 'b4b94ec8-609b-478e-a220-34b01afbbed9'
                }
            ];

            processChatData(mockData);
        }

        // å¤„ç†èŠå¤©æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        function processChatData(rawData) {
            // æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            allChats = rawData.sort((a, b) => b.timestamp - a.timestamp);
            filteredChats = [...allChats];
            currentPage = 0;
            
            updateStats();
            renderChatsLazy(); // ä½¿ç”¨æ‡’åŠ è½½æ¸²æŸ“
            
            document.getElementById('loadingState').style.display = 'none';
            
            // æ·»åŠ æ»šåŠ¨åŠ è½½æ›´å¤šåŠŸèƒ½
            setupInfiniteScroll();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const prompts = allChats.filter(chat => chat.type === 'prompt');
            const responses = allChats.filter(chat => chat.type === 'generation');
            const lastActivity = allChats.length > 0 ? new Date(allChats[0].timestamp) : null;
            
            document.getElementById('totalChats').textContent = Math.ceil(allChats.length / 2);
            document.getElementById('totalPrompts').textContent = prompts.length;
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('lastActivity').textContent = lastActivity ? 
                lastActivity.toLocaleTimeString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',  // åŒ—äº¬æ—¶é—´
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '--:--';
        }

        // æ‡’åŠ è½½æ¸²æŸ“èŠå¤©è®°å½•
        function renderChatsLazy() {
            const chatList = document.getElementById('chatList');
            
            if (filteredChats.length === 0) {
                chatList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem;">ğŸ’­</div>
                        <h3>æš‚æ— èŠå¤©è®°å½•</h3>
                        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¯¹è¯è®°å½•</p>
                    </div>
                `;
                return;
            }

            // åªæ¸²æŸ“å½“å‰é¡µçš„æ•°æ®
            const startIndex = 0;
            const endIndex = Math.min((currentPage + 1) * ITEMS_PER_PAGE, filteredChats.length);
            const visibleChats = filteredChats.slice(startIndex, endIndex);
            
            const chatHTML = visibleChats.map(chat => {
                const time = chat.time || new Date(chat.timestamp).toLocaleTimeString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const isPrompt = chat.type === 'prompt';
                const cssClass = isPrompt ? 'prompt' : 'response';
                const icon = isPrompt ? 'ğŸ‘¤' : 'ğŸ¤–';
                const label = isPrompt ? 'ç”¨æˆ·æé—®' : 'AIå›å¤';
                
                // æˆªæ–­è¿‡é•¿çš„æ–‡æœ¬
                const maxLength = 500;
                const displayText = chat.text.length > maxLength ? 
                    chat.text.substring(0, maxLength) + '...' : 
                    chat.text;
                
                return `
                    <div class="chat-item" data-id="${chat.id}">
                        <div class="${cssClass}">
                            <div class="chat-meta">
                                <span>${icon} ${label}</span>
                                <span>${time}</span>
                            </div>
                            <div class="chat-text">${escapeHtml(displayText)}</div>
                            ${chat.text.length > maxLength ? 
                                `<button class="expand-btn" onclick="expandText(${chat.id})">å±•å¼€å…¨æ–‡</button>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            chatList.innerHTML = chatHTML;
            
            // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
            if (endIndex < filteredChats.length) {
                chatList.innerHTML += `
                    <div class="load-more-container">
                        <button class="load-more-btn" onclick="loadMoreChats()">
                            ğŸ“¥ åŠ è½½æ›´å¤š (è¿˜æœ‰ ${filteredChats.length - endIndex} æ¡)
                        </button>
                    </div>
                `;
            }
        }

        // åŠ è½½æ›´å¤šèŠå¤©è®°å½•
        function loadMoreChats() {
            currentPage++;
            renderChatsLazy();
        }

        // å±•å¼€æ–‡æœ¬
        function expandText(chatId) {
            const chat = allChats.find(c => c.id === chatId);
            if (chat) {
                const chatElement = document.querySelector(`[data-id="${chatId}"] .chat-text`);
                const expandBtn = document.querySelector(`[data-id="${chatId}"] .expand-btn`);
                
                // ä½¿ç”¨fullTextå¦‚æœå­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨text
                const fullText = chat.fullText || chat.text;
                chatElement.innerHTML = escapeHtml(fullText);
                
                if (expandBtn) expandBtn.remove();
            }
        }

        // è®¾ç½®æ— é™æ»šåŠ¨
        function setupInfiniteScroll() {
            const chatList = document.getElementById('chatList');
            
            chatList.addEventListener('scroll', debounce(() => {
                if (chatList.scrollTop + chatList.clientHeight >= chatList.scrollHeight - 100) {
                    if ((currentPage + 1) * ITEMS_PER_PAGE < filteredChats.length) {
                        loadMoreChats();
                    }
                }
            }, 100));
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æœç´¢åŠŸèƒ½ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        document.getElementById('searchBox').addEventListener('input', debounce(function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredChats = [...allChats];
            } else {
                filteredChats = allChats.filter(chat => 
                    chat.text.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 0; // é‡ç½®åˆ†é¡µ
            renderChatsLazy();
        }, 300)); // 300msé˜²æŠ–

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = `
                <div class="error-message">
                    <strong>æç¤º</strong><br>
                    ${message.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡æ˜¾ç¤ºèŠå¤©å†å²');
            // è‡ªåŠ¨åŠ è½½çœŸå®æ•°æ®
            loadChatData();
        });
    </script>
</body>
</html> 